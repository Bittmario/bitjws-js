<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for dist/bitws-js.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">dist/</a> bitws-js.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.02% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>80/86</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">61.11% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>11/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>7/7</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.02% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>80/86</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var sjcl = require('sjcl');
var bitcore = require('bitcore-lib');
var Mnemonic = require('bitcore-mnemonic');
var assign = require('object-assign');
var Message = require('bitcore-message');
var base64url = require('base64-url');
var stringify = require('json-stable-stringify');
&nbsp;
/*
    Here it will concatenate the rest of the files on src/lib
    The build task includes concatenation and uglify, it runs everytime you change a file on /src
    To activate teh automatic build on everychange you need to have grunt running
    To run the task build automatically you need to run: grunt build
&nbsp;
    To make changes and develop do them with grunt dev running with teh command: grunt dev
&nbsp;
    Order of the concatenated files:
        dependencies
        auth, keys, etc..
        index
*/
;
var WORDSIZE = 4;  /* 32 bits. */
var ITERCOUNT = 10000;
&nbsp;
/**
 * Generate a salt and derive keys based on the username and password given.
 * PBKDF2-HMAC-SHA256 is used for key stretching with a default iteration
 * count of 10000.
 *
 * @param {string} username
 * @param {string} password
 * @param {number} [iters=10000] - Number of iterations for PBKDF2.
 * @param {string} [salt] - Salt as hexadecimal digits.
 * @returns {object}
 */
function deriveKeys(username, password, iters, salt) {
  var saltHex, rawSalt, iterCount;
  var data = username + password;
  var check = checkBytes(data);
&nbsp;
  if (salt) {
    rawSalt = sjcl.codec.hex.toBits(salt);
    saltHex = salt;
  } else {
    rawSalt = sjcl.random.randomWords(16 / WORDSIZE);
    saltHex = sjcl.codec.hex.fromBits(rawSalt);
  }
&nbsp;
  /* Use PBKDF2-HMAC-SHA256 to generate a base key for usage with BIP39. */
  if (!iters) {
    iterCount = ITERCOUNT + Math.abs(sjcl.random.randomWords(1)[0] % 1024);
  } else {
    iterCount = Math.max(iters, 5000);
  }
  var baseKey = sjcl.misc.pbkdf2(data, rawSalt, iterCount);
  var words = Mnemonic.fromSeed(keyToBuffer(baseKey), Mnemonic.Words.ENGLISH);
&nbsp;
  var keys = recoverKeys(words);
&nbsp;
  return {
    payload: {
      username: username,
      check: check,
      salt: saltHex,
      iterations: iterCount
    },
    key: keys,
    mnemonic: words.toString()
  };
}
&nbsp;
&nbsp;
/**
 * Produce keys for encrypting, signing requests, and generating wallets
 * from the given words using BIP39.
 *
 * The encrypting key corresponds to the key derived at m/0', the
 * signing key (and the respective public address) at m/1', and
 * m/2' for the wallet gen key which is expected to be further derived
 * for each wallet belonging to the same user.
 *
 * @param {string} mnemonic - a string of words or an instance of Mnemonic.
 * @returns {object}
 */
function recoverKeys(mnemonic) {
  var words = (mnemonic instanceof Mnemonic) ? mnemonic : <span class="branch-1 cbranch-no" title="branch not covered" >Mnemonic(mnemonic);</span>
  var hdkey = words.toHDPrivateKey();
  var rawEncKey = hdkey.derive(0, true);
  var rawSignKey = hdkey.derive(1, true);
  var rawGenKey = hdkey.derive(2, true);
&nbsp;
  var encKey = sjcl.codec.hex.toBits(rawEncKey.privateKey.bn.toJSON());
  var signKey = rawSignKey.privateKey;
  var signAddress = rawSignKey.publicKey.toAddress().toString();
&nbsp;
  return {
    sign: {
      key: signKey,
      address: signAddress,
      raw: rawSignKey
    },
    encrypt: encKey,
    genWallet: rawGenKey
  };
}
&nbsp;
&nbsp;
/**
 * Convert data stored as a sequence of 8 elements composed of
 * 4 bytes each to a sequence of bytes as a Buffer.
 *
 * @example
 * ```javascript
 * var bitws = require('bitws-js');
 *
 * var data = bitws.keys.deriveKeys('my username', 'my password');
 * var buffer = bitws.keys.keyToBuffer(data.key.encrypt);
 * ```
 *
 * @param {array} key - array of length 8
 * @returns {object}
 */
function keyToBuffer(key) {
  var abuffer = new ArrayBuffer(32);  /* 256 bits. */
  var iview = new Int32Array(abuffer);
  var bview = new Uint8Array(abuffer);
&nbsp;
  <span class="missing-if-branch" title="if path not taken" >I</span>if (iview.length != key.length) {
<span class="cstat-no" title="statement not covered" >    throw new Error("Unexpected length");</span>
  }
&nbsp;
  for (var i = 0; i &lt; iview.length; i++) {
    iview[i] = key[i];
  }
&nbsp;
  return new Buffer(bview);
}
&nbsp;
&nbsp;
/**
 * Return the last 6 hexadecimal digits from SHA256(data).
 *
 * @param {string} data
 * @returns {string}
 */
function checkBytes(data) {
  var hash = sjcl.hash.sha256.hash(data);
  var hex = sjcl.codec.hex.fromBits(hash);
  var check = hex.slice(-6);
  return check;
}
;
/**
 * Return a JWT header base64url encoded. The keyId is stored in the header
 * and used when verifying the signature.
 *
 * @param {keyId} string
 * @returns {string}
 * @private
 */
function jwtHeader(keyId) {
  var data = {
    typ: 'JWT',
    alg: 'CUSTOM-BITCOIN-SIGN',
    kid: keyId
  };
&nbsp;
  return base64url.encode(stringify(data));
}
&nbsp;
&nbsp;
/**
 * Return a signed JWT message. By default the expiration claim (exp) is
 * set to one hour in the future and the issued at claim (iat) is the current
 * unix timestamp * 1000.
 *
 * @example
 * ```javascript
 * var bitws = require('bitws-js');
 *
 * var data = bitws.keys.deriveKeys('my username', 'my password');
 *
 * var payload = {data: data.payload};
 * var audience = 'https://example.com';
 * var raw = bitws.auth.signSerialize(audience, payload, data.key.sign);
 * ```
 *
 * @param {string} url - Used as the audience (aud) in the JWT claims.
 * @param {object} payload - Arbitrary data to be added to the JWT payload.
 * @param {object} sign - An object that contains at least "address" and "key".
 * @returns {string}
 */
function signSerialize(url, payload, sign) {
  var msg;
  var rawPayload;
  var signature;
  var claims = {};
&nbsp;
  /* JWT claims. */
  /* Expiration time (exp) is used to disallow considering the payload
   * if it's received too late. Default to now + 1 hour. */
  claims.exp = (new Date().getTime() / 1000) + 3600;
  /* Issued at (iat) is used as an increasing nonce. */
  claims.iat = new Date().getTime();
  /* Audience (aud) is specified so the signature takes into account
   * the expected receiver. */
  claims.aud = url;
&nbsp;
  rawPayload = base64url.encode(stringify(assign(claims, payload)));
  msg = jwtHeader(sign.address) + '.' + rawPayload;
  signature = base64url.encode(new Message(msg).sign(sign.key));
&nbsp;
  return msg + '.' + signature;
}
&nbsp;
&nbsp;
/**
 * Verify a signed JWT message and return its header and payload if
 * the signature matches.
 *
 * @param {string} url - Used as the audience (aud) in the JWT claims.
 * @param {string} raw - signed JWT message received.
 * @returns {object}
 */
function validateDeserialize(url, raw) {
  var rawHeader, rawPayload, signature;
  var key, header, payload;
  var pieces = raw.split('.');
&nbsp;
  <span class="missing-if-branch" title="if path not taken" >I</span>if (pieces.length != 3) {
<span class="cstat-no" title="statement not covered" >    throw new TypeError("Invalid raw data");</span>
  }
  rawHeader = pieces[0];
  rawPayload = pieces[1];
  signature = base64url.decode(pieces[2]);
&nbsp;
  header = JSON.parse(base64url.decode(rawHeader));
  key = header.kid;
  <span class="missing-if-branch" title="if path not taken" >I</span>if (!key) {
<span class="cstat-no" title="statement not covered" >    throw new TypeError("Invalid header, missing key id");</span>
  }
  <span class="missing-if-branch" title="if path not taken" >I</span>if (!(new Message(rawHeader + '.' + rawPayload).verify(key, signature))) {
<span class="cstat-no" title="statement not covered" >    throw new Error("Signature does not match");</span>
  }
&nbsp;
  payload = JSON.parse(base64url.decode(rawPayload));
  <span class="missing-if-branch" title="if path not taken" >I</span>if (payload.aud !== url) {
<span class="cstat-no" title="statement not covered" >    throw new Error("Audience mismatch (" + payload.aud + " != " + url + ")");</span>
  } else <span class="missing-if-branch" title="if path not taken" >I</span>if (new Date().getTime() / 1000 &gt; payload.exp) {
<span class="cstat-no" title="statement not covered" >    throw new Error("Payload expired");</span>
  }
&nbsp;
  return {header: header, payload: payload};
}
;
module.exports = {
    signSerialize : signSerialize,
    validateDeserialize : validateDeserialize,
    deriveKeys : deriveKeys,
    recoverKeys : recoverKeys,
    keyToBuffer : keyToBuffer,
    checkBytes : checkBytes
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Apr 12 2016 09:56:22 GMT+0200 (CEST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
